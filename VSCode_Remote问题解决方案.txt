================================================================================
        VSCode Remote-SSH Copilot 无法使用问题 - 诊断与解决方案
================================================================================

📅 日期: 2025年10月16日
👤 用户: xcr
🔧 问题: VSCode Remote-SSH 只能运行精简版 CLI Server，无法使用 Copilot 等扩展

================================================================================
一、问题分析
================================================================================

❌ 错误信息:
   "当前远程端口运行的是 VS Code 的精简版 CLI Server，只支持"纯文本编辑器 + 终端"
    的功能，不支持 Copilot Chat、Python、Jupyter等扩展。"

🔍 根本原因:
   **磁盘空间不足！**

   服务器磁盘使用情况:
   - 文件系统: /dev/nvme1n1p2
   - 总容量: 879GB
   - 已使用: 830GB (100%)
   - 可用空间: 仅 4.4GB
   - 挂载点: /

📦 VSCode Server 需求:
   - 完整的 VSCode Server 需要下载和解压 300-500MB 的文件
   - 扩展（Copilot、Python、Jupyter等）也需要额外空间
   - 当磁盘空间不足时，VSCode 只能启动精简版 CLI Server

🗂️ 磁盘占用分布:
   /home/admin/     802GB  ⚠️ 主要占用者！
   /home/hft/        12GB
   /usr/              8.4GB
   /snap/             7.8GB
   /var/              5.4GB
   /home/xcr/       952KB

================================================================================
二、解决方案
================================================================================

【方案1: 清理磁盘空间】（推荐，彻底解决）
------------------------------------------

目标: 至少释放 5-10GB 空间

1. 清理 /home/admin 目录（占用 802GB）
   
   # 检查 admin 目录内容（需要 root 权限）
   sudo du -h --max-depth=1 /home/admin/ | sort -hr | head -20
   
   # 根据检查结果，删除不需要的文件
   # 建议优先清理：
   - 旧的备份文件
   - 临时文件和缓存
   - 不再使用的数据文件
   - 重复的文件

2. 清理系统缓存和日志
   
   # 清理 apt 缓存
   sudo apt clean
   sudo apt autoclean
   
   # 清理旧的日志文件
   sudo journalctl --vacuum-size=500M
   
   # 清理旧的 snap 版本
   sudo snap list --all | awk '/disabled/{print $1, $3}' | \
       while read snapname revision; do \
           sudo snap remove "$snapname" --revision="$revision"; \
       done

3. 清理 Docker（如果安装了）
   
   # 清理未使用的容器、镜像、网络
   docker system prune -a --volumes

4. 清理用户缓存
   
   # 清理 hft 用户的缓存
   rm -rf ~/.cache/*
   
   # 清理 conda 缓存（如果有）
   conda clean --all -y

5. 检查并删除大文件
   
   # 查找大于 1GB 的文件
   sudo find /home -type f -size +1G -exec ls -lh {} \; 2>/dev/null
   
   # 查找大于 500MB 的文件
   sudo find /home -type f -size +500M -exec ls -lh {} \; 2>/dev/null


【方案2: 为 xcr 用户配置独立工作目录】（临时方案）
------------------------------------------

如果无法清理 /home/admin，可以将 xcr 的工作目录移到其他分区：

1. 检查是否有其他分区有足够空间
   
   df -h

2. 创建软链接到有空间的分区
   
   # 假设 /mnt/data 有足够空间
   sudo mkdir -p /mnt/data/vscode-xcr
   sudo chown xcr:xcr /mnt/data/vscode-xcr
   
   # 移除现有的 .vscode-server
   sudo rm -rf /home/xcr/.vscode-server
   
   # 创建软链接
   sudo -u xcr ln -s /mnt/data/vscode-xcr /home/xcr/.vscode-server


【方案3: 增加磁盘空间】（根本解决）
------------------------------------------

1. 检查是否可以扩容现有分区
   
   # 查看磁盘分区
   sudo fdisk -l
   sudo lsblk

2. 如果是虚拟机，联系管理员扩容虚拟磁盘

3. 如果是物理机，考虑：
   - 添加新硬盘
   - 更换更大容量硬盘
   - 将部分目录（如 /home/admin）移动到新磁盘


【方案4: 临时清理给 xcr 使用】（快速方案）
------------------------------------------

只需释放 1-2GB 即可让 VSCode Server 正常运行：

1. 清理系统缓存（最快）
   
   sudo apt clean
   sudo journalctl --vacuum-size=200M

2. 清理 hft 用户的缓存
   
   rm -rf ~/.cache/*

3. 重启 VSCode Remote 连接


【方案5: 联系 admin 用户】
------------------------------------------

由于 /home/admin 占用了 802GB（91%），需要联系该用户：

1. 检查是否有不需要的数据
2. 将数据移动到外部存储
3. 压缩或归档旧数据

================================================================================
三、执行步骤（推荐方案 - 快速清理）
================================================================================

以下是快速释放空间的步骤，不会影响重要数据：

步骤1: 清理系统缓存
-------------------
sudo apt clean
sudo apt autoclean
sudo journalctl --vacuum-size=200M

预计释放: 500MB - 2GB

步骤2: 清理旧的 snap 版本
-------------------------
# 列出所有 snap 包
sudo snap list --all

# 删除旧版本（保留当前版本）
sudo sh -c 'snap list --all | awk "/disabled/{print \$1, \$3}" | while read snapname revision; do snap remove "$snapname" --revision="$revision"; done'

预计释放: 1-3GB

步骤3: 清理用户缓存
-------------------
# 清理 hft 用户缓存
rm -rf ~/.cache/*

# 清理 xcr 用户缓存
sudo rm -rf /home/xcr/.cache/*

预计释放: 300-500MB

步骤4: 检查磁盘空间
-------------------
df -h /

目标: 至少有 5GB 可用空间

步骤5: 重新连接 VSCode
----------------------
1. 在本地 VSCode 中断开 SSH 连接
2. 删除本地的连接缓存：
   - Mac/Linux: rm -rf ~/.vscode/remote-ssh
   - Windows: 删除 %USERPROFILE%\.vscode\remote-ssh
3. 重新连接到服务器
4. VSCode 会自动下载完整的 Server 组件

================================================================================
四、预防措施
================================================================================

1. 设置磁盘使用监控
   
   # 创建监控脚本
   cat > ~/check_disk.sh << 'EOF'
#!/bin/bash
USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $USAGE -gt 90 ]; then
    echo "警告: 磁盘使用率达到 ${USAGE}%"
    df -h /
fi
EOF
   
   chmod +x ~/check_disk.sh
   
   # 添加到 crontab（每天检查）
   (crontab -l 2>/dev/null; echo "0 9 * * * ~/check_disk.sh") | crontab -

2. 定期清理
   
   # 每月清理一次缓存和日志
   sudo apt clean
   sudo journalctl --vacuum-time=30d
   rm -rf ~/.cache/*

3. 配置日志轮转
   
   # 限制日志大小
   sudo nano /etc/systemd/journald.conf
   # 设置: SystemMaxUse=500M

4. 使用配额限制用户磁盘使用
   
   # 安装 quota
   sudo apt install quota
   
   # 为用户设置配额（需要配置）

================================================================================
五、验证解决方案
================================================================================

清理完成后，验证步骤：

1. 检查磁盘空间
   df -h /
   
   确认可用空间 > 5GB

2. 检查 xcr 用户权限
   sudo -u xcr touch /home/xcr/test && sudo rm /home/xcr/test
   
   应该能正常创建和删除文件

3. 删除旧的 VSCode Server
   sudo rm -rf /home/xcr/.vscode-server/*

4. 重新连接 VSCode
   - 断开当前连接
   - 清理本地缓存
   - 重新连接

5. 安装扩展测试
   - 在远程 VSCode 中安装 Python 或 Copilot 扩展
   - 检查是否能正常使用

================================================================================
六、快速命令参考
================================================================================

# 检查磁盘使用
df -h /

# 查看目录占用（前20）
sudo du -h --max-depth=1 /home/ | sort -hr | head -20

# 清理系统（安全，不会删除重要文件）
sudo apt clean && sudo apt autoclean && sudo journalctl --vacuum-size=200M

# 查找大文件（大于 1GB）
sudo find /home -type f -size +1G -exec ls -lh {} \; 2>/dev/null

# 删除 xcr 的 VSCode Server（让其重新下载）
sudo rm -rf /home/xcr/.vscode-server

# 测试 xcr 用户写入权限
sudo -u xcr touch /home/xcr/test_write && sudo rm /home/xcr/test_write && echo "OK"

================================================================================
七、联系信息
================================================================================

如需帮助：
  - 服务器管理员: hft
  - Admin 用户清理: 联系 admin 用户清理其 802GB 数据

关键信息：
  - 问题根源: 磁盘 100% 满
  - 主要占用: /home/admin (802GB)
  - 需要空间: 至少 5GB
  - 推荐清理: 见"三、执行步骤"

================================================================================
                            问题可以解决！
================================================================================

💡 最快解决方法：执行"三、执行步骤"中的命令，释放 2-5GB 空间即可。
